<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>å®Œæ•´è¯¾ç¨‹çŠ¶æ€ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .status-box {
            background: #fff;
            border: 2px solid #ccc;
            padding: 20px;
            margin: 10px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .current-status {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
            min-height: 36px;
        }
        .time-left {
            font-size: 18px;
            color: #666;
            min-height: 24px;
        }
        .settings {
            margin: 20px 0;
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .schedule-table td, .schedule-table th {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .schedule-table th {
            background: #f8f8f8;
        }
        .highlight {
            background-color: #e6f3ff !important;
        }
        .warning {
            color: #c00;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="status-box">
        <div class="current-status" id="statusText">æ­£åœ¨åˆå§‹åŒ–...</div>
        <div class="time-left" id="timeLeft"></div>
    </div>

    <div class="settings">
        <h3>é“ƒå£°è®¾ç½®</h3>
        <label>
            <input type="checkbox" id="classBell"> ä¸Šè¯¾æ’­æ”¾æç¤ºéŸ³
        </label>
        <br>
        <label>
            <input type="checkbox" id="breakBell"> ä¸‹è¯¾æ’­æ”¾æç¤ºéŸ³
        </label>
        <p class="warning">* é¦–æ¬¡ä½¿ç”¨éœ€ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®æ¿€æ´»å£°éŸ³</p>
    </div>

    <table class="schedule-table" id="scheduleTable">
        <tr>
            <th>æ—¶æ®µ</th>
            <th>å¼€å§‹æ—¶é—´</th>
            <th>ç»“æŸæ—¶é—´</th>
        </tr>
    </table>

    <script>
        // è¯¾ç¨‹é…ç½®æ•°æ®
        var schedule = [
            { name: "ç¬¬ä¸€èŠ‚è¯¾", start: "2025-02-04T08:00", end: "2025-02-04T08:50" },
            { name: "ç¬¬äºŒèŠ‚è¯¾", start: "2025-02-04T09:00", end: "2025-02-04T09:50" },
            { name: "ç¬¬ä¸‰èŠ‚è¯¾", start: "2025-02-04T10:10", end: "2025-02-04T11:00" },
            { name: "ç¬¬å››èŠ‚è¯¾", start: "2025-02-04T11:10", end: "2025-02-04T12:00" }
        ];

        // éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–
        var audioContext = {
            element: document.createElement('audio'),
            sounds: {
                classStart: 'class_start.mp3',  // æ›¿æ¢ä¸ºå®é™…ä¸Šè¯¾é“ƒå£°æ–‡ä»¶
                classEnd: 'class_end.mp3'       // æ›¿æ¢ä¸ºå®é™…ä¸‹è¯¾é“ƒå£°æ–‡ä»¶
            },
            play: function(soundType) {
                if (this.sounds[soundType]) {
                    this.element.src = this.sounds[soundType];
                    this.element.play().catch(function(e) {
                        console.log('æ’­æ”¾å¤±è´¥:', e);
                    });
                }
            }
        };
        document.body.appendChild(audioContext.element);

        // æ—¶é—´è§£æå‡½æ•°ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function parseTime(datetimeStr) {
            var parts = datetimeStr.split(/[-T:]/);
            return new Date(
                parseInt(parts[0]),     // å¹´
                parseInt(parts[1])-1,   // æœˆï¼ˆ0-basedï¼‰
                parseInt(parts[2]),     // æ—¥
                parseInt(parts[3]),     // æ—¶
                parseInt(parts[4]),     // åˆ†
                0                       // ç§’
            );
        }

        // çŠ¶æ€ç®¡ç†å™¨
        var stateManager = {
            currentClass: null,
            lastClass: null,
            update: function() {
                var now = new Date();
                this.lastClass = this.currentClass;
                this.currentClass = null;

                // æŸ¥æ‰¾å½“å‰è¯¾ç¨‹
                for (var i = 0; i < schedule.length; i++) {
                    var start = parseTime(schedule[i].start);
                    var end = parseTime(schedule[i].end);
                    
                    if (now >= start && now <= end) {
                        this.currentClass = schedule[i];
                        break;
                    }
                }

                // è§¦å‘çŠ¶æ€å˜åŒ–æ£€æµ‹
                this.checkStateChange();
            },
            checkStateChange: function() {
                var changed = false;
                var isStart = false;

                // ä»æ— åˆ°æœ‰ï¼šå¼€å§‹ä¸Šè¯¾
                if (this.currentClass && !this.lastClass) {
                    changed = true;
                    isStart = true;
                }
                // ä»æœ‰åˆ°æ— ï¼šä¸‹è¯¾
                else if (!this.currentClass && this.lastClass) {
                    changed = true;
                    isStart = false;
                }
                // æ¢è¯¾ï¼ˆå½“æœ‰è¿ç»­è¯¾ç¨‹æ—¶ï¼‰
                else if (this.currentClass && this.lastClass && 
                        this.currentClass !== this.lastClass) {
                    changed = true;
                    isStart = true;
                }

                if (changed) {
                    this.handleBell(isStart);
                }
            },
            handleBell: function(isStart) {
                var settingKey = isStart ? 'classBell' : 'breakBell';
                if (localStorage.getItem(settingKey) !== 'false') {
                    var soundType = isStart ? 'classStart' : 'classEnd';
                    audioContext.play(soundType);
                }
            }
        };

        // ç•Œé¢æ›´æ–°å‡½æ•°
        function updateDisplay() {
            var now = new Date();
            var statusText = document.getElementById('statusText');
            var timeLeft = document.getElementById('timeLeft');
            
            if (stateManager.currentClass) {
                // ä¸Šè¯¾çŠ¶æ€
                var endTime = parseTime(stateManager.currentClass.end);
                var remain = endTime - now;
                
                statusText.innerHTML = "ğŸ“š " + stateManager.currentClass.name + " è¿›è¡Œä¸­";
                statusText.style.color = "#c00";
                timeLeft.innerHTML = "å‰©ä½™æ—¶é—´ï¼š" + formatTime(remain);
                
                // æ›´æ–°è¯¾ç¨‹è¡¨é«˜äº®
                highlightCurrentClass();
            } else {
                // ä¸‹è¯¾çŠ¶æ€
                statusText.innerHTML = "ğŸ•’ è¯¾é—´ä¼‘æ¯ä¸­";
                statusText.style.color = "#090";
                
                // æŸ¥æ‰¾ä¸‹ä¸€èŠ‚è¯¾
                var nextClass = null;
                for (var i = 0; i < schedule.length; i++) {
                    var start = parseTime(schedule[i].start);
                    if (now < start) {
                        nextClass = schedule[i];
                        break;
                    }
                }
                
                if (nextClass) {
                    var nextStart = parseTime(nextClass.start);
                    var remain = nextStart - now;
                    timeLeft.innerHTML = "è·ç¦» " + nextClass.name + " è¿˜æœ‰ï¼š" + formatTime(remain);
                } else {
                    timeLeft.innerHTML = "ä»Šæ—¥è¯¾ç¨‹å·²å…¨éƒ¨ç»“æŸ ğŸ‰";
                }
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
        function formatTime(ms) {
            var totalSeconds = Math.floor(ms / 1000);
            var minutes = Math.floor(totalSeconds / 60);
            var seconds = totalSeconds % 60;
            return minutes + "åˆ†" + (seconds < 10 ? "0" : "") + seconds + "ç§’";
        }

        // åˆå§‹åŒ–è¯¾ç¨‹è¡¨
        function initScheduleTable() {
            var table = document.getElementById('scheduleTable');
            
            schedule.forEach(function(cls, index) {
                var row = table.insertRow(-1);
                row.innerHTML = '<td>' + cls.name + '</td>' +
                                '<td>' + cls.start.split('T')[1] + '</td>' +
                                '<td>' + cls.end.split('T')[1] + '</td>';
                
                // æ·»åŠ æ•°æ®å±æ€§ä¾¿äºé«˜äº®
                row.setAttribute('data-class-index', index);
            });
        }

        // é«˜äº®å½“å‰è¯¾ç¨‹
        function highlightCurrentClass() {
            var rows = document.querySelectorAll('#scheduleTable tr');
            rows.forEach(function(row) {
                row.classList.remove('highlight');
            });
            
            if (stateManager.currentClass) {
                var index = schedule.indexOf(stateManager.currentClass);
                var targetRow = document.querySelector(
                    'tr[data-class-index="' + index + '"]'
                );
                if (targetRow) {
                    targetRow.classList.add('highlight');
                }
            }
        }

        // è®¾ç½®åˆå§‹åŒ–
        function initSettings() {
            // ä»æœ¬åœ°å­˜å‚¨è¯»å–è®¾ç½®
            document.getElementById('classBell').checked = 
                localStorage.getItem('classBell') !== 'false';
            document.getElementById('breakBell').checked = 
                localStorage.getItem('breakBell') !== 'false';

            // ä¿å­˜è®¾ç½®
            document.getElementById('classBell').onchange = function() {
                localStorage.setItem('classBell', this.checked);
            };
            document.getElementById('breakBell').onchange = function() {
                localStorage.setItem('breakBell', this.checked);
            };
        }

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            initScheduleTable();
            initSettings();
            
            // åˆå§‹åŒ–ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆè§£å†³è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
            document.body.onclick = function() {
                // é€šè¿‡ç©ºæ’­æ”¾æ¿€æ´»éŸ³é¢‘æƒé™
                audioContext.element.play().then(function() {
                    audioContext.element.pause();
                    audioContext.element.currentTime = 0;
                }).catch(function(e) {
                    console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                });
            };

            // å¯åŠ¨å®šæ—¶æ›´æ–°
            setInterval(function() {
                stateManager.update();
                updateDisplay();
            }, 1000);
            
            // é¦–æ¬¡æ›´æ–°
            stateManager.update();
            updateDisplay();
        }

        // å¯åŠ¨ç³»ç»Ÿ
        init();
    </script>
</body>
</html>
