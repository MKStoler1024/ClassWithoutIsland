<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>课程状态系统完整版</title>
    <style>
        /* 基础样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* 状态显示框 */
        .status-box {
            background: #fff;
            border: 2px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 36px;
            color: #2c3e50;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        .status-label {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
        }

        /* 课程表格 */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border: 1px solid #ddd;
        }
        .schedule-table th {
            background: #f8f8f8;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .schedule-table td {
            padding: 12px;
            border: 1px solid #ddd;
        }
        .current-class {
            background-color: #e8f5e9 !important;
        }
        .future-class {
            background-color: #e3f2fd !important;
        }
        .past-class {
            background-color: #f5f5f5 !important;
            color: #999;
        }

        /* 全屏模式 */
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            padding: 0;
            margin: 0;
        }
        .fullscreen-mode .status-box {
            width: 100%;
            height: 100%;
            border: none;
            box-shadow: none;
            border-radius: 0;
            padding: 20px;
            display: table;
        }
        .fullscreen-mode .time-display {
            font-size: 15vw;
            line-height: 1.2;
            display: table-cell;
            vertical-align: middle;
        }
        .fullscreen-mode .status-label {
            font-size: 6vw;
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
        }

        /* 控制按钮 */
        .control-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
        }
        .control-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            margin-left: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        /* 设置面板 */
        .settings-panel {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-bar">
            <button class="control-btn" onclick="toggleFullscreen()">全屏</button>
            <button class="control-btn" onclick="testSound('classStart')">测试上课铃</button>
            <button class="control-btn" onclick="testSound('classEnd')">测试下课铃</button>
        </div>

        <div class="status-box">
            <div class="status-label" id="statusLabel">正在初始化...</div>
            <div class="time-display" id="timeDisplay">--:--</div>
            <div id="timeDescription" style="text-align:center"></div>
        </div>

        <div class="settings-panel">
            <h3>系统设置</h3>
            <label>
                <input type="checkbox" id="classBell"> 启用上课铃声
            </label>
            <br>
            <label>
                <input type="checkbox" id="breakBell"> 启用下课铃声
            </label>
        </div>

        <table class="schedule-table" id="scheduleTable">
            <tr>
                <th>课程名称</th>
                <th>时间段</th>
                <th>状态</th>
            </tr>
        </table>
    </div>

    <script>
        // 课程配置
        var courseSchedule = [
            { name: "第一节课", start: "08:00", end: "08:50" },
            { name: "第二节课", start: "09:00", end: "09:50" },
            { name: "第三节课", start: "10:10", end: "11:00" },
            { name: "第四节课", start: "11:10", end: "12:00" },
            { name: "第一节课", start: "13:30", end: "14:20" },
            { name: "第二节课", start: "14:30", end: "15:20" },
            { name: "第三节课", start: "15:40", end: "16:30" },
            { name: "第四节课", start: "16:40", end: "17:30" },
            { name: "第一节课", start: "18:00", end: "18:50" },
            { name: "第二节课", start: "19:00", end: "19:50" },
            { name: "第三节课", start: "20:10", end: "21:00" },
            { name: "第四节课", start: "21:10", end: "22:00" }
        ];

        // 音频系统
        var audioElement = document.createElement('audio');
        document.body.appendChild(audioElement);
        var soundFiles = {
            classStart: 'class_start.mp3',
            classEnd: 'class_end.mp3'
        };

        // 全局状态
        var isFullscreen = false;
        var currentCourse = null;
        var lastCourse = null;

        // 时间处理
        function parseTime(timeStr) {
            var now = new Date();
            var parts = timeStr.split(':');
            return new Date(
                now.getFullYear(),
                now.getMonth(),
                now.getDate(),
                parseInt(parts[0]),
                parseInt(parts[1]),
                0
            );
        }

        // 更新课程状态
        function updateCourseStatus() {
            var now = new Date();
            currentCourse = null;

            for (var i = 0; i < courseSchedule.length; i++) {
                var course = courseSchedule[i];
                var start = parseTime(course.start);
                var end = parseTime(course.end);
                
                if (end < start) end.setDate(end.getDate() + 1);
                
                if (now >= start && now <= end) {
                    currentCourse = course;
                    break;
                }
            }

            if (currentCourse !== lastCourse) {
                handleStatusChange();
                lastCourse = currentCourse;
            }
        }

        // 处理状态变化
        function handleStatusChange() {
            if (!currentCourse && localStorage.breakBell === 'true') {
                playSound('classEnd');
            } else if (currentCourse && localStorage.classBell === 'true') {
                playSound('classStart');
            }
        }

        // 播放声音
        function playSound(type) {
            audioElement.src = soundFiles[type];
            audioElement.play().catch(function(e) {
                console.log('播放失败:', e);
            });
        }

        // 更新界面
        function updateDisplay() {
            var now = new Date();
            var timeDisplay = document.getElementById('timeDisplay');
            var statusLabel = document.getElementById('statusLabel');
            var timeDesc = document.getElementById('timeDescription');

            if (currentCourse) {
                var endTime = parseTime(currentCourse.end);
                var remain = endTime - now;
                statusLabel.textContent = currentCourse.name + ' 进行中';
                timeDisplay.textContent = formatTime(remain);
                timeDesc.textContent = '剩余时间';
            } else {
                statusLabel.textContent = '课间休息中';
                var nextCourse = getNextCourse();
                if (nextCourse) {
                    var startTime = parseTime(nextCourse.start);
                    var remain = startTime - now;
                    timeDisplay.textContent = formatTime(remain);
                    timeDesc.textContent = '距离 ' + nextCourse.name;
                } else {
                    timeDisplay.textContent = '00:00';
                    timeDesc.textContent = '今日课程已结束';
                }
            }
            updateScheduleTable();
        }

        // 格式化时间
        function formatTime(ms) {
            if (ms < 0) return '00:00';
            var totalSeconds = Math.floor(ms / 1000);
            var minutes = Math.floor(totalSeconds / 60);
            var seconds = totalSeconds % 60;
            return (minutes < 10 ? '0' : '') + minutes + ':' + 
                   (seconds < 10 ? '0' : '') + seconds;
        }

        // 更新课程表
        function updateScheduleTable() {
            var now = new Date();
            var rows = document.querySelectorAll('#scheduleTable tr:not(:first-child)');
            
            for (var i = 0; i < rows.length; i++) {
                var course = courseSchedule[i];
                var start = parseTime(course.start);
                var end = parseTime(course.end);
                var row = rows[i];
                
                row.className = '';
                if (now >= start && now <= end) {
                    row.className = 'current-class';
                } else if (now < start) {
                    row.className = 'future-class';
                } else {
                    row.className = 'past-class';
                }
            }
        }

        // 获取下一节课
        function getNextCourse() {
            var now = new Date();
            for (var i = 0; i < courseSchedule.length; i++) {
                var start = parseTime(courseSchedule[i].start);
                if (start > now) return courseSchedule[i];
            }
            return null;
        }

        // 全屏切换
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            
            // 传统浏览器适配
            if (isFullscreen) {
                document.querySelector('.settings-panel').style.display = 'none';
                document.querySelector('.schedule-table').style.display = 'none';
            } else {
                document.querySelector('.settings-panel').style.display = '';
                document.querySelector('.schedule-table').style.display = '';
            }
        }

        // 测试铃声
        function testSound(type) {
            if (confirm('确定要测试' + (type === 'classStart' ? '上课' : '下课') + '铃声吗？')) {
                playSound(type);
            }
        }

        // 初始化
        function init() {
            // 初始化课程表
            var table = document.getElementById('scheduleTable');
            courseSchedule.forEach(function(course) {
                var row = table.insertRow(-1);
                row.innerHTML = '<td>' + course.name + '</td>' +
                                '<td>' + course.start + ' - ' + course.end + '</td>' +
                                '<td></td>';
            });

            // 初始化设置
            document.getElementById('classBell').checked = localStorage.classBell === 'true';
            document.getElementById('breakBell').checked = localStorage.breakBell === 'true';
            
            document.getElementById('classBell').onchange = function() {
                localStorage.classBell = this.checked;
            };
            document.getElementById('breakBell').onchange = function() {
                localStorage.breakBell = this.checked;
            };

            // 启动更新
            setInterval(function() {
                updateCourseStatus();
                updateDisplay();
            }, 1000);
            updateCourseStatus();
            updateDisplay();

            // 激活音频权限
            document.body.onclick = function() {
                audioElement.play().then(function() {
                    audioElement.pause();
                });
                this.onclick = null;
            };
        }

        init();
    </script>
</body>
</html>
